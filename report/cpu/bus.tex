\documentclass[../main/report.tex]{subfiles}
\begin{document}
\section{Communication with GPU}

The backbone of the interaction between the CPU and GPU is the giant bus connecting them.
Since the GPU is designed to increase the performance of the system by parallelizing operations,
it's important that the bus does not introduce too much overhead.
We therefore designed a parallel bus based on the EBI specifications provided
in the reference manual for the EFM32GG\cite[p.175]{efm32gg}.
The bus has a 16-bit data line, and a 20-bit address line, as well as six control signals.

All the pins connected between the MCU and the FPGA follow the specifications from the EFM32GG's Reference Manual\cite[p.175]{efm32gg},
which means the bus can be memory mapped on the microcontroller.
This opens for very simple bus programming, taking advantage of the \textit{emlib} software library.

The CPU can interface three different memories for different purposes:

\begin{enumerate}
    \item Constant memory, for storing constants which may be read by kernels.
    \item Instruction memory, for containing the kernels.
    \item Data memory, for storing the framebuffer, in addition to other data for kernels.
\end{enumerate}

The data memory is located on dedicated SRAM chips,
and the CPU can write to it in a separate address space from the memory located on the FPGA.
This makes it easy to write to different memories, simply by writing to different addresses.
Since both instruction and constant memory is located on the same FPGA,
they are memory mapped to the same bank on the microcontroller.
Separating them is simply done with an address offset,
which is possible because their combined address space is smaller than the one of the data memory.

\begin{figure}[H]
    \centering
    \begin{tabularx}{\textwidth}{|X|X|X|X|X|}
    \multicolumn{1}{c}{0x80000000} & \multicolumn{1}{c}{0x80040000} & \multicolumn{1}{c}{0x80080000} & \multicolumn{1}{c}{0x80100000} & \multicolumn{1}{c}{0x84000000} \\ \hline
    Constant Memory & Instruction Memory & Kernel start area & X & Data memory \\ \hline
    \end{tabular}
    \caption{Address format for loading a parameter.}
    \label{fig:memory_map}
\end{figure}

\end{document}
